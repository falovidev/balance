<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>OCR + Registro con Categoría Detectada</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #output { white-space: pre-wrap; margin-bottom: 1em; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f0f0f0; }
    .highlight { background-color: #e0ffe0; }
  </style>
</head>
<body>
  <h2>OCR desde navegador + Registro automático</h2>
  <input type="file" id="imageInput" accept="image/*" multiple>
  <pre id="output">Texto reconocido:</pre>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Tipo</th>
        <th>Monto</th>
        <th>Categoría</th>
        <th>Fecha</th>
        <th>Fuente</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const input = document.getElementById('imageInput');
    const output = document.getElementById('output');
    const table = document.getElementById('dataTable').querySelector('tbody');

    // Función que analiza el texto OCR y extrae los datos
    function extraerDatos(texto) {
      // Buscar palabra justo después de "Conversación"
      const categoriaMatch = texto.match(/Conversaci[oó]n\s+(\w+)/i);
      const categoria = categoriaMatch ? categoriaMatch[1] : 'desconocido';
      const tipo = categoria !== 'desconocido' ? 'egreso' : 'desconocido';

      // Buscar monto con formato $25.000,00
      const montoMatch = texto.match(/\$?\s?(\d{1,3}(?:\.\d{3})*,\d{2})/);
      const monto = montoMatch ? montoMatch[1].replace(/\./g, '').replace(',', '.') : '0.00';

      // Buscar fecha tipo: 25 de junio de 2025 o 25dejuniode2025
      const fechaTextoMatch = texto.match(/(\d{1,2})\s*de?\s*junio\s*de?\s*(\d{4})/i) ||
                              texto.match(/(\d{1,2})\s*de?junio\s*de?(\d{4})/i) ||
                              texto.match(/(\d{1,2})\s*dejunio\s*(\d{4})/i);
      let fecha = '';
      if (fechaTextoMatch) {
        const dia = fechaTextoMatch[1].padStart(2, '0');
        const mes = '06';
        const anio = fechaTextoMatch[2];
        fecha = `${dia}/${mes}/${anio}`;
      }

      return { tipo, monto, categoria, fecha };
    }

    input.addEventListener('change', async () => {
      const files = input.files;
      if (!files.length) return;

      const worker = await Tesseract.createWorker({ logger: m => console.log(m) });
      await worker.load();
      await worker.loadLanguage('spa');
      await worker.initialize('spa');

      let fullText = '';

      for (const file of files) {
        output.textContent = `Procesando: ${file.name}...`;
        const { data: { text } } = await worker.recognize(file);
        fullText += `\n\n--- ${file.name} ---\n${text}`;

        const datos = extraerDatos(text);

        // Crear y llenar una fila en la tabla
        const fila = document.createElement('tr');
        fila.classList.add('highlight');
        fila.innerHTML = `
          <td>${datos.tipo}</td>
          <td>${datos.monto}</td>
          <td>${datos.categoria}</td>
          <td>${datos.fecha || 'Fecha no detectada'}</td>
          <td>${file.name}</td>
        `;
        table.appendChild(fila);
      }

      output.textContent = fullText;
      await worker.terminate();
    });
  </script>
</body>
</html>
